#!/bin/bash
if [ -z "$MAC" ]; then
	alias gdate=date
	alias gsed=sed
	alias gecho=echo
	DATE=date
else
	DATE=gdate
fi
#https://stackoverflow.com/a/246128/1562087
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
db=~/.hist.db
odb=~/.history-old.db

if [ "$1" == "-d" ]; then
	db=~/.hist.test.db
	set -Ceux
	shift
fi

command="$1"

function sql() {
	sqlite3 $db "$@"
}
function sql_select_cmd() {
	if [ "$1" == "-n" ]; then
		local commandid="commandid,"
		shift
	fi
	if [ "$1" == "-l" ]; then
		#local commandid="commandid,"
		local long=true
		shift
	fi
	#sql "SELECT ${long:+commandid,}command FROM commands $@"
	if [ "$long" == true ]; then
		sql "SELECT runtimes.runid,runtimes.cmd,commands.command,directory,at,duration FROM runtimes LEFT JOIN commands ON runtimes.cmd = commands.commandid LEFT JOIN directories ON wd = directoryid $@"
	else
		sql "SELECT ${long:+commandid,}command FROM commands $@"
	fi
}

case "$command" in
	init) 
		arg=${2:-""}
		if [ "$arg" == "-f" ]; then
			echo -n remove\ 
			rm -v $db
		fi
		if [ -f $db ]; then
			echo $db already exists
			exit 1
		fi
		sql < $DIR/histool.schema.sql
	;;
	debug) 
		shift
		args="$@"
		sql "$@"
	;;
	searchold|so) 
		shift
		args="$@"
		if [ -z "$args" ]; then
			echo No search param!
			exit 1
		fi
		sqlite3 $odb "SELECT typed FROM history WHERE typed LIKE '%$args%'"
	;;
	search|s) 
		shift
		if [ "$1" == "-l" ]; then
			long=true
			shift
	   	fi
		args="$@"
		if [ -z "$args" ]; then
			echo No search param!
			exit 1
		fi
		sql_select_cmd ${long:+-l} "WHERE command LIKE '%$args%'"
	;;
	list|l) 
		long=""
		if [ "$1" == "-l" ]; then
			long=true
			shift
		fi
		if [ $# -gt 2 ]; then
			limit="$1"
			limits="LIMIT $limit"
		else
			limits=""
		fi
		sql_select_cmd -n "$limits"
	;;
	save|sa) 
		shift
		pwd=$(pwd)
		at=$1
		duration=$((`$DATE +%s` - ${at:-0}))
		shift
		cmd="$@"
		cmd="${cmd//\'/''}"
		getlastrow='SELECT last_insert_rowid()'
		cmdid=`sql "INSERT INTO commands(command) VALUES ('$cmd'); $getlastrow"`
		pwdid=`sql "INSERT INTO directories(directory) VALUES ('$pwd'); $getlastrow"`
		#sql "INSERT INTO commands(command) VALUES ('$cmd')"
		#sql "INSERT INTO directories(directory) VALUES ('$pwd')"
		if [ $cmdid == 0 ]; then
			cmdid=`sql "SELECT rowid FROM commands WHERE command = '$cmd'"`
		fi
		if [ "$pwdid" == 0 ]; then
			pwdid=`sql "SELECT rowid FROM directories WHERE directory = '$pwd'"`
		fi
		sql "INSERT INTO runtimes(at,duration,cmd,wd) VALUES ($at,$duration,$cmdid,$pwdid)"
	;;
	*)
		echo Invalid!
		exit 1
	;;
esac
